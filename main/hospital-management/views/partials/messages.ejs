<div class="card">
  <div class="card-header">
    <h2 class="card-title">Messages</h2>
    <div class="d-flex gap-2">
      <button class="btn btn-sm <%= activeFolder === 'inbox' ? 'btn-primary' : 'btn-outline' %>" 
              onclick="window.location.href='?folder=inbox'">
        <i class="fas fa-inbox"></i> Inbox
      </button>
      <button class="btn btn-sm <%= activeFolder === 'sent' ? 'btn-primary' : 'btn-outline' %>" 
              onclick="window.location.href='?folder=sent'">
        <i class="fas fa-paper-plane"></i> Sent
      </button>
    </div>
  </div>
  <div class="card-body">
    <% if (messages.length === 0) { %>
      <div class="alert alert-info">No messages found</div>
    <% } else { %>
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <% if (activeFolder === 'inbox') { %>
                <th>From</th>
              <% } else { %>
                <th>To</th>
              <% } %>
              <th>Subject</th>
              <th>Message</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% messages.forEach(message => { %>
              <tr class="<%= !message.is_read && activeFolder === 'inbox' ? 'unread-message' : '' %>">
                <% if (activeFolder === 'inbox') { %>
                  <td>
                    <% if (message.sender_role === 'admin') { %>
                      Admin
                    <% } else if (message.sender_role === 'doctor') { %>
                      <%= message.sender_name %>
                    <% } else { %>
                      <%= message.sender_name %>
                    <% } %>
                  </td>
                <% } else { %>
                  <td>
                    <% if (message.receiver_role === 'admin') { %>
                      Admin
                    <% } else if (message.receiver_role === 'doctor') { %>
                      <%= message.receiver_name %>
                    <% } else { %>
                      <%= message.receiver_name %>
                    <% } %>
                  </td>
                <% } %>
                <td><%= message.subject %></td>
                <td><%= message.message.substring(0, 50) %>...</td>
                <td><%= new Date(message.created_at).toLocaleString() %></td>
                <td>
                  <button class="btn btn-sm btn-primary view-message" 
                          data-id="<%= message.id %>"
                          data-sender="<%= activeFolder === 'inbox' ? message.sender_name : message.receiver_name %>"
                          data-subject="<%= message.subject %>"
                          data-message="<%= message.message %>"
                          data-date="<%= new Date(message.created_at).toLocaleString() %>">
                    <i class="fas fa-eye"></i> View
                  </button>
                  <% if (activeFolder === 'inbox') { %>
                    <button class="btn btn-sm btn-success reply-message" 
                            data-id="<%= message.id %>"
                            data-sender="<%= message.sender_name %>"
                            data-sender-id="<%= message.sender_id %>"
                            data-sender-role="<%= message.sender_role %>">
                      <i class="fas fa-reply"></i> Reply
                    </button>
                  <% } %>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
    <% } %>
  </div>
</div>

<!-- Message Modal -->
<div class="modal hidden" id="messageModal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <div class="modal-header">
      <h3 id="modalSubject"></h3>
      <p class="text-muted" id="modalSender"></p>
      <p class="text-muted" id="modalDate"></p>
    </div>
    <div class="modal-body">
      <p id="modalMessage"></p>
    </div>
  </div>
</div>

<!-- Reply Modal -->
<div class="modal hidden" id="replyModal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <div class="modal-header">
      <h3>Reply to Message</h3>
    </div>
    <div class="modal-body">
      <form id="replyForm" method="POST">
        <input type="hidden" id="replySenderId" name="receiver_id">
        <input type="hidden" id="replySenderRole" name="receiver_type">
        <div class="form-group">
          <label for="replySubject">Subject</label>
          <input type="text" class="form-control" id="replySubject" name="subject" required>
        </div>
        <div class="form-group">
          <label for="replyMessage">Message</label>
          <textarea class="form-control" id="replyMessage" name="message" rows="5" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Send Reply</button>
      </form>
    </div>
  </div>
</div>

<script>
  // View message modal
  document.querySelectorAll('.view-message').forEach(button => {
    button.addEventListener('click', function() {
      document.getElementById('modalSubject').textContent = this.dataset.subject;
      document.getElementById('modalSender').textContent = `From: ${this.dataset.sender}`;
      document.getElementById('modalDate').textContent = `Date: ${this.dataset.date}`;
      document.getElementById('modalMessage').textContent = this.dataset.message;
      document.getElementById('messageModal').classList.remove('hidden');
      
      // Mark as read if in inbox
      if (window.location.search.includes('folder=inbox')) {
        fetch(`/messages/read/${this.dataset.id}`, { method: 'POST' })
          .then(() => this.closest('tr').classList.remove('unread-message'));
      }
    });
  });

  // Reply message modal
  document.querySelectorAll('.reply-message').forEach(button => {
    button.addEventListener('click', function() {
      document.getElementById('replySenderId').value = this.dataset.senderId;
      document.getElementById('replySenderRole').value = this.dataset.senderRole;
      document.getElementById('replySubject').value = `Re: ${this.dataset.subject}`;
      document.getElementById('replyForm').action = `/${user.role}/messages/send`;
      document.getElementById('replyModal').classList.remove('hidden');
    });
  });

  // Close modals
  document.querySelectorAll('.close').forEach(closeBtn => {
    closeBtn.addEventListener('click', function() {
      this.closest('.modal').classList.add('hidden');
    });
  });

  // Close modal when clicking outside
  window.addEventListener('click', function(event) {
    if (event.target.classList.contains('modal')) {
      event.target.classList.add('hidden');
    }
  });
</script>